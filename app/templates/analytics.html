<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STIGA Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics_compare.css') }}">
</head>
<body>
    <header class="analytics-header">
        <div class="header-content">
            <h1 class="analytics-title">üìä STIGA Analytics</h1>
            <div class="mode-toggle">
                <button id="singleModeBtn" class="active" onclick="switchMode('single')">Single Period</button>
                <button id="compareModeBtn" onclick="switchMode('compare')">Compare Periods</button>
            </div>
        </div>
    </header>

    <div class="date-selector-container">
        <div class="date-selector">
            <div id="singleDatePicker" class="date-picker-mode">
                <div class="date-row">
                    <span class="date-label">Period:</span>
                    <div class="date-inputs">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" id="singleDateFrom" value="{{ date_from }}">
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" id="singleDateTo" value="{{ date_to }}">
                        </div>
                    </div>
                    <button class="preset-btn" onclick="applySingleDates()">Apply</button>
                </div>
                <div class="date-row">
                    <span class="date-label">Quick:</span>
                    <div class="quick-presets">
                        <button class="preset-btn" onclick="setQuickRange('today')">Today</button>
                        <button class="preset-btn" onclick="setQuickRange('yesterday')">Yesterday</button>
                        <button class="preset-btn" onclick="setQuickRange('week')">Last 7 Days</button>
                        <button class="preset-btn" onclick="setQuickRange('month')">Last 30 Days</button>
                    </div>
                </div>
            </div>

            <div id="compareDatePicker" class="date-picker-mode" style="display: none;">
                <div class="date-row">
                    <span class="date-label">Period A:</span>
                    <div class="date-inputs">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" id="periodAFrom">
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" id="periodATo">
                        </div>
                    </div>
                </div>
                <div class="date-row">
                    <span class="date-label">Period B:</span>
                    <div class="date-inputs">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" id="periodBFrom">
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" id="periodBTo">
                        </div>
                    </div>
                </div>
                <div class="date-row">
                    <span class="date-label">Quick:</span>
                    <div class="quick-presets">
                        <button class="preset-btn" onclick="setComparePreset('week')">This Week vs Last Week</button>
                        <button class="preset-btn" onclick="setComparePreset('month')">This Month vs Last Month</button>
                    </div>
                    <button class="preset-btn" onclick="applyCompareDates()">Compare</button>
                </div>
            </div>
        </div>
    </div>

    <div class="kpi-grid" id="kpiGrid">
        <div id="singleKPIs">
            <div class="kpi-card" onclick="drillDownKPI('sessions')">
                <div class="kpi-header">
                    <span class="kpi-label">Sessions</span>
                    <span class="kpi-icon">üë•</span>
                </div>
                <div class="kpi-value" id="kpiSessions">{{ kpis.total_sessions }}</div>
            </div>
            <div class="kpi-card" onclick="drillDownKPI('queries')">
                <div class="kpi-header">
                    <span class="kpi-label">Queries</span>
                    <span class="kpi-icon">üîç</span>
                </div>
                <div class="kpi-value" id="kpiQueries">{{ kpis.total_queries }}</div>
            </div>
            <div class="kpi-card" onclick="drillDownKPI('clicks')">
                <div class="kpi-header">
                    <span class="kpi-label">Clicks</span>
                    <span class="kpi-icon">üëÜ</span>
                </div>
                <div class="kpi-value" id="kpiClicks">{{ kpis.total_clicks }}</div>
            </div>
            <div class="kpi-card" onclick="drillDownKPI('ctr')">
                <div class="kpi-header">
                    <span class="kpi-label">Click Rate</span>
                    <span class="kpi-icon">üìà</span>
                </div>
                <div class="kpi-value" id="kpiCTR">{{ kpis.ctr_percent }}%</div>
            </div>
        </div>
        <div id="compareKPIs" style="display: none;"></div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìà Daily Trends</h3>
            </div>
            <div id="dailyTrendsChart" style="height: 400px;"></div>
        </div>
    </div>

    <div class="products-table-container">
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">üèÜ Top Products Performance</h3>
            </div>
            <div style="overflow-x: auto;">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th class="single-mode-col">Product</th>
                            <th class="single-mode-col">Shown</th>
                            <th class="single-mode-col">Clicked</th>
                            <th class="single-mode-col">CTR</th>
                            <th class="compare-mode-col" style="display: none;">Product</th>
                            <th class="compare-mode-col" style="display: none;">Period A</th>
                            <th class="compare-mode-col" style="display: none;">Period B</th>
                            <th class="compare-mode-col" style="display: none;">Œî CTR</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loadingState" class="loading" style="display: none;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
        <p>Loading analytics data...</p>
    </div>

    <div id="errorState" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="errorMessage"></span>
    </div>

    <script>
        let currentMode = 'single';
        const initialData = {
            date_from: '{{ date_from }}',
            date_to: '{{ date_to }}',
            kpis: {{ kpis | tojson }},
            daily_stats: {{ daily_stats | tojson }},
            top_products: {{ top_products | tojson }}
        };

        document.addEventListener('DOMContentLoaded', function() {
            renderSingleMode(initialData);
            renderDailyChart(initialData.daily_stats, 'single');
            renderProductsTable(initialData.top_products, 'single');
        });

        function drillDownKPI(metric) {
            const from = document.getElementById('singleDateFrom').value;
            const to = document.getElementById('singleDateTo').value;
            window.location.href = `/analytics/daily?metric=${metric}&date_from=${from}&date_to=${to}`;
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
            document.getElementById('compareModeBtn').classList.toggle('active', mode === 'compare');
            document.getElementById('singleDatePicker').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('compareDatePicker').style.display = mode === 'compare' ? 'block' : 'none';
            document.getElementById('singleKPIs').style.display = mode === 'single' ? 'contents' : 'none';
            document.getElementById('compareKPIs').style.display = mode === 'compare' ? 'contents' : 'none';
            document.querySelectorAll('.single-mode-col').forEach(el => {
                el.style.display = mode === 'single' ? 'table-cell' : 'none';
            });
            document.querySelectorAll('.compare-mode-col').forEach(el => {
                el.style.display = mode === 'compare' ? 'table-cell' : 'none';
            });
            if (mode === 'compare') {
                initializeCompareMode();
            }
        }

        function setQuickRange(range) {
            const today = new Date();
            let from, to;
            switch(range) {
                case 'today':
                    from = to = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    from = to = yesterday.toISOString().split('T')[0];
                    break;
                case 'week':
                    from = new Date(today);
                    from.setDate(from.getDate() - 7);
                    from = from.toISOString().split('T')[0];
                    to = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    from = new Date(today);
                    from.setDate(from.getDate() - 30);
                    from = from.toISOString().split('T')[0];
                    to = today.toISOString().split('T')[0];
                    break;
            }
            document.getElementById('singleDateFrom').value = from;
            document.getElementById('singleDateTo').value = to;
            applySingleDates();
        }

        function applySingleDates() {
            const from = document.getElementById('singleDateFrom').value;
            const to = document.getElementById('singleDateTo').value;
            window.location.href = `/analytics?date_from=${from}&date_to=${to}`;
        }

        function initializeCompareMode() {
            const today = new Date();
            const lastWeekStart = new Date(today);
            lastWeekStart.setDate(lastWeekStart.getDate() - 14);
            const lastWeekEnd = new Date(today);
            lastWeekEnd.setDate(lastWeekEnd.getDate() - 8);
            const thisWeekStart = new Date(today);
            thisWeekStart.setDate(thisWeekStart.getDate() - 7);
            document.getElementById('periodAFrom').value = lastWeekStart.toISOString().split('T')[0];
            document.getElementById('periodATo').value = lastWeekEnd.toISOString().split('T')[0];
            document.getElementById('periodBFrom').value = thisWeekStart.toISOString().split('T')[0];
            document.getElementById('periodBTo').value = today.toISOString().split('T')[0];
        }

        function setComparePreset(preset) {
            const today = new Date();
            let aFrom, aTo, bFrom, bTo;
            if (preset === 'week') {
                aFrom = new Date(today);
                aFrom.setDate(aFrom.getDate() - 14);
                aTo = new Date(today);
                aTo.setDate(aTo.getDate() - 8);
                bFrom = new Date(today);
                bFrom.setDate(bFrom.getDate() - 7);
                bTo = today;
            } else if (preset === 'month') {
                aFrom = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                aTo = new Date(today.getFullYear(), today.getMonth(), 0);
                bFrom = new Date(today.getFullYear(), today.getMonth(), 1);
                bTo = today;
            }
            document.getElementById('periodAFrom').value = aFrom.toISOString().split('T')[0];
            document.getElementById('periodATo').value = aTo.toISOString().split('T')[0];
            document.getElementById('periodBFrom').value = bFrom.toISOString().split('T')[0];
            document.getElementById('periodBTo').value = bTo.toISOString().split('T')[0];
            applyCompareDates();
        }

        async function applyCompareDates() {
            const aFrom = document.getElementById('periodAFrom').value;
            const aTo = document.getElementById('periodATo').value;
            const bFrom = document.getElementById('periodBFrom').value;
            const bTo = document.getElementById('periodBTo').value;
            showLoading(true);
            try {
                const response = await fetch('/api/analytics/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        period_a: {start: aFrom, end: aTo},
                        period_b: {start: bFrom, end: bTo}
                    })
                });
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                renderCompareMode(data);
                showLoading(false);
            } catch (error) {
                showError(error.message);
                showLoading(false);
            }
        }

        function renderSingleMode(data) {
            document.getElementById('kpiSessions').textContent = data.kpis.total_sessions || 0;
            document.getElementById('kpiQueries').textContent = data.kpis.total_queries || 0;
            document.getElementById('kpiClicks').textContent = data.kpis.total_clicks || 0;
            document.getElementById('kpiCTR').textContent = (data.kpis.ctr_percent || 0) + '%';
        }

        function renderCompareMode(data) {
            const compareContainer = document.getElementById('compareKPIs');
            compareContainer.innerHTML = '';
            const metrics = [
                {key: 'sessions', label: 'Sessions', icon: 'üë•'},
                {key: 'queries', label: 'Queries', icon: 'üîç'},
                {key: 'clicks', label: 'Clicks', icon: 'üëÜ'},
                {key: 'ctr', label: 'CTR', icon: 'üìà', isPercent: true}
            ];
            metrics.forEach(metric => {
                const valueA = data.period_a.kpis[metric.key];
                const valueB = data.period_b.kpis[metric.key];
                const delta = data.deltas[metric.key];
                const isSignificant = metric.key === 'ctr' && data.significance.is_significant;
                const card = document.createElement('div');
                card.className = 'kpi-card';
                card.innerHTML = `
                    <div class="kpi-header">
                        <span class="kpi-label">${metric.label}</span>
                        <span class="kpi-icon">${metric.icon}</span>
                    </div>
                    <div class="kpi-comparison">
                        <div class="kpi-period">
                            <span class="kpi-period-label">Period A</span>
                            <div class="kpi-period-value">${valueA}${metric.isPercent ? '%' : ''}</div>
                        </div>
                        <div class="kpi-period">
                            <span class="kpi-period-label">Period B</span>
                            <div class="kpi-period-value">${valueB}${metric.isPercent ? '%' : ''}</div>
                        </div>
                    </div>
                    <div class="kpi-delta ${delta.direction}">
                        <span>${delta.direction === 'increase' ? '‚Üë' : delta.direction === 'decrease' ? '‚Üì' : '‚Üí'}</span>
                        <span>${Math.abs(delta.absolute)}${metric.isPercent ? 'pp' : ''}</span>
                        ${isSignificant ? '<span class="significance-badge">‚ú® Significativo</span>' : ''}
                    </div>
                `;
                compareContainer.appendChild(card);
            });
            renderDailyChart(data.daily_trends, 'compare');
            renderProductsTable(data.products_comparison, 'compare');
        }

        function renderDailyChart(data, mode) {
            if (mode === 'single') {
                const trace = {
                    x: data.map(d => d.date),
                    y: data.map(d => d.total_sessions || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Sessions',
                    line: {color: '#00E5FF', width: 3},
                    marker: {size: 8}
                };
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#ffffff'},
                    xaxis: {gridcolor: 'rgba(0, 229, 255, 0.1)'},
                    yaxis: {gridcolor: 'rgba(0, 229, 255, 0.1)'},
                    margin: {t: 20, r: 20, b: 40, l: 60}
                };
                Plotly.newPlot('dailyTrendsChart', [trace], layout, {responsive: true});
            } else {
                const traceA = {
                    x: data.period_a.map(d => d.date),
                    y: data.period_a.map(d => d.ctr || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Period A',
                    line: {color: '#00E5FF', width: 3}
                };
                const traceB = {
                    x: data.period_b.map(d => d.date),
                    y: data.period_b.map(d => d.ctr || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Period B',
                    line: {color: '#FFA726', width: 3}
                };
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: '#ffffff'},
                    xaxis: {gridcolor: 'rgba(0, 229, 255, 0.1)'},
                    yaxis: {gridcolor: 'rgba(0, 229, 255, 0.1)', title: 'CTR (%)'},
                    margin: {t: 20, r: 20, b: 40, l: 60}
                };
                Plotly.newPlot('dailyTrendsChart', [traceA, traceB], layout, {responsive: true});
            }
        }

        function renderProductsTable(products, mode) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No data available</td></tr>';
                return;
            }
            products.forEach(product => {
                const row = tbody.insertRow();
                if (mode === 'single') {
                    row.innerHTML = `
                        <td class="product-name">${product.product_name || 'N/A'}</td>
                        <td class="stat-cell">${product.shown_count || 0}</td>
                        <td class="stat-cell">${product.click_count || 0}</td>
                        <td class="ctr-value">${(product.ctr || 0).toFixed(2)}%</td>
                    `;
                } else {
                    const deltaClass = product.delta_ctr.direction;
                    const deltaArrow = product.delta_ctr.direction === 'increase' ? '‚Üë' : 
                                     product.delta_ctr.direction === 'decrease' ? '‚Üì' : '‚Üí';
                    row.innerHTML = `
                        <td class="product-name">${product.name}</td>
                        <td class="stat-cell">${product.period_a.shown}/${product.period_a.clicked} (${product.period_a.ctr}%)</td>
                        <td class="stat-cell">${product.period_b.shown}/${product.period_b.clicked} (${product.period_b.ctr}%)</td>
                        <td class="delta-cell ${deltaClass}">
                            <span class="delta-arrow">${deltaArrow}</span>
                            <span>${Math.abs(product.delta_ctr.absolute).toFixed(2)}pp</span>
                        </td>
                    `;
                }
            });
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }
    </script>
</body>
</html>